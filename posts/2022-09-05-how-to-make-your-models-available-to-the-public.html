<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.299">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Suvaditya Mukherjee">
<meta name="dcterms.date" content="2022-09-05">
<meta name="description" content="Explaining how to use Docker, Flask and Gunicorn to deploy your models online">

<title>Suvaditya Mukherjee - How to make your models available to the public</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XHQD3SPP05"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XHQD3SPP05', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Suvaditya Mukherjee</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../talks.html" rel="" target="">
 <span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../writings.html" rel="" target="">
 <span class="menu-text">Writings</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/suvadityamuk" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/halcyonrayes" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/suvadityamukherjee" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">How to make your models available to the public</h1>
                  <div>
        <div class="description">
          Explaining how to use Docker, Flask and Gunicorn to deploy your models online
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">mlops</div>
                <div class="quarto-category">docker</div>
                <div class="quarto-category">computer-vision</div>
                <div class="quarto-category">ai</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Suvaditya Mukherjee </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 5, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#what-is-covered-in-this-tutorial" id="toc-what-is-covered-in-this-tutorial" class="nav-link" data-scroll-target="#what-is-covered-in-this-tutorial">What is covered in this tutorial?</a></li>
  <li><a href="#create-a-custom-model-using-keras" id="toc-create-a-custom-model-using-keras" class="nav-link" data-scroll-target="#create-a-custom-model-using-keras">1) Create a custom model using Keras</a>
  <ul class="collapse">
  <li><a href="#import-headers" id="toc-import-headers" class="nav-link" data-scroll-target="#import-headers">Import headers</a></li>
  <li><a href="#set-options" id="toc-set-options" class="nav-link" data-scroll-target="#set-options">Set options</a></li>
  <li><a href="#model-definition" id="toc-model-definition" class="nav-link" data-scroll-target="#model-definition">Model definition</a></li>
  <li><a href="#requirements-file" id="toc-requirements-file" class="nav-link" data-scroll-target="#requirements-file">Requirements file</a></li>
  </ul></li>
  <li><a href="#prepare-an-inference-pipeline" id="toc-prepare-an-inference-pipeline" class="nav-link" data-scroll-target="#prepare-an-inference-pipeline">2) Prepare an inference pipeline</a>
  <ul class="collapse">
  <li><a href="#inference-function" id="toc-inference-function" class="nav-link" data-scroll-target="#inference-function">Inference function</a></li>
  </ul></li>
  <li><a href="#make-a-simple-flask-app-to-expose-model-for-inference" id="toc-make-a-simple-flask-app-to-expose-model-for-inference" class="nav-link" data-scroll-target="#make-a-simple-flask-app-to-expose-model-for-inference">3) Make a simple Flask App to expose model for inference</a>
  <ul class="collapse">
  <li><a href="#flask-app-definition" id="toc-flask-app-definition" class="nav-link" data-scroll-target="#flask-app-definition">Flask App definition</a></li>
  <li><a href="#definition-of-health-check-endpoint" id="toc-definition-of-health-check-endpoint" class="nav-link" data-scroll-target="#definition-of-health-check-endpoint">Definition of health-check endpoint</a></li>
  <li><a href="#definition-of-inference-endpoint" id="toc-definition-of-inference-endpoint" class="nav-link" data-scroll-target="#definition-of-inference-endpoint">Definition of inference endpoint</a></li>
  </ul></li>
  <li><a href="#define-a-dockerfile-which-uses-gunicorn-for-deployment" id="toc-define-a-dockerfile-which-uses-gunicorn-for-deployment" class="nav-link" data-scroll-target="#define-a-dockerfile-which-uses-gunicorn-for-deployment">4) Define a Dockerfile which uses Gunicorn for deployment</a>
  <ul class="collapse">
  <li><a href="#dockerfile" id="toc-dockerfile" class="nav-link" data-scroll-target="#dockerfile">Dockerfile</a></li>
  <li><a href="#dockerignore" id="toc-dockerignore" class="nav-link" data-scroll-target="#dockerignore">.dockerignore</a></li>
  </ul></li>
  <li><a href="#build-our-image" id="toc-build-our-image" class="nav-link" data-scroll-target="#build-our-image">5) Build our image</a></li>
  <li><a href="#define-a-simple-github-actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository" id="toc-define-a-simple-github-actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository" class="nav-link" data-scroll-target="#define-a-simple-github-actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository">6) Define a simple GitHub Actions workflow to build your image every time you push it to your repository</a></li>
  <li><a href="#test-the-pipeline" id="toc-test-the-pipeline" class="nav-link" data-scroll-target="#test-the-pipeline">Test the pipeline</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#future-scope" id="toc-future-scope" class="nav-link" data-scroll-target="#future-scope">Future Scope</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#interesting-links" id="toc-interesting-links" class="nav-link" data-scroll-target="#interesting-links">Interesting Links</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>An end-to-end Machine Learning solution is an important way to bring AI to production and make it available for mass consumption and usage. But today, most AI practitioners simply do the pre-processing, training, evaluation and tuning stages and leave the remaining part to DevOps engineers.</p>
<p>As such, a new field of development named <a href="https://blogs.nvidia.com/blog/2020/09/03/what-is-mlops/">MLOps</a> has come into the mainstream. The focus has shifted from simply training and evaluation to also bringing and integrating it to production pipelines.</p>
<p>On an individual level as well, knowing how to bring your model to the public is an important tool to have in an AI practitioner’s skill-set.</p>
<p>In this article, we will be exploring how we can perform a small segment of the MLOps cycle in a simple and efficient manner using <strong>Keras</strong>, <strong>Flask</strong>, <strong>Gunicorn</strong> and <strong>Docker</strong>.</p>
<p>If you wish to skip through and go straight to the code, <a href="https://github.com/suvadityamuk/KerasDocker">click here to go to the GitHub repository</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/docker-blog/dockerblog.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image</figcaption><p></p>
</figure>
</div>
</section>
<section id="what-is-covered-in-this-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="what-is-covered-in-this-tutorial">What is covered in this tutorial?</h2>
<ol type="1">
<li>Create a custom model using <strong><code>Keras</code></strong> and its off-the-shelf components<br>
</li>
<li>Prepare an inference pipeline<br>
</li>
<li>Develop a simple <code>Flask</code> app to <strong>expose the model for inference</strong><br>
</li>
<li>Define a <code>Dockerfile</code> using <code>Gunicorn</code><br>
</li>
<li><strong>Build our image</strong></li>
<li>Define a simple <strong>Github Actions workflow</strong> to build your image every time you push it to your repository</li>
</ol>
</section>
<section id="create-a-custom-model-using-keras" class="level2">
<h2 class="anchored" data-anchor-id="create-a-custom-model-using-keras">1) Create a custom model using Keras</h2>
<p>As an example, we are going to create a simple model using the Keras Functional API and an off-the-shelf MobileNetV2 model from <code>keras.applications</code> pretrained on ImageNet.</p>
<section id="import-headers" class="level3">
<h3 class="anchored" data-anchor-id="import-headers">Import headers</h3>
<p>We require <code>tensorflow</code>, <code>keras</code>, <code>Flask</code>, <code>PIL</code> and <code>os</code> for this tutorial. If using a virtual environment, you can use the <code>requirements.txt</code> file below to get your env prepared.</p>
<ul>
<li><code>tensorflow</code>: Used for matrix operations and back-end for keras</li>
<li><code>keras</code>: Used for high-level Deep Learning model-building API and get pre-trained model</li>
<li><code>Flask</code>: Used for building simple API for inference</li>
<li><code>PIL</code>: Used for handling images</li>
<li><code>os</code>: Used for setting environment variables</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> request, jsonify</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-options" class="level3">
<h3 class="anchored" data-anchor-id="set-options">Set options</h3>
<p>Since GPUs are a difficult resource to get a hold of, we set a Tensorflow flag to make any CUDA devices present invisible in the first place. <em>If you can run your container on a GPU, feel free to skip this line.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To force inference using CPU only</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'CUDA_VISIBLE_DEVICES'</span>] <span class="op">=</span> <span class="st">'-1'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-definition" class="level3">
<h3 class="anchored" data-anchor-id="model-definition">Model definition</h3>
<p>This model is made using the Keras Functional API. We take a simple <code>keras.Input</code> which accepts color (RGB) images of any size.<br>
The input is passed via the following layers:<br>
- <code>keras.layers.Resizing</code> : Used to resize the image tensor to a <strong>224x224x3</strong> tensor - <code>keras.layers.Rescaling</code> : Used to rescale the image tensor values from a [0,255] range to a [0,1] range - <code>keras.applications.MobileNetV2</code> : Used to import the <strong>MobileNetV2</strong> instance from Keras (pretrained on ImageNet)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>image_input <span class="op">=</span> keras.Input(shape<span class="op">=</span>(<span class="va">None</span>,<span class="va">None</span>,<span class="dv">3</span>))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Resizing(height<span class="op">=</span><span class="dv">224</span>, width<span class="op">=</span><span class="dv">224</span>, interpolation<span class="op">=</span><span class="st">'lanczos3'</span>, crop_to_aspect_ratio<span class="op">=</span><span class="va">False</span>)(image_input)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> keras.layers.Rescaling(scale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>, offset<span class="op">=</span><span class="fl">0.0</span>)(x)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>mobilenet <span class="op">=</span> keras.applications.MobileNetV2(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    include_top<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    weights<span class="op">=</span><span class="st">"imagenet"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    input_tensor<span class="op">=</span>image_input,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    classes<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    classifier_activation<span class="op">=</span><span class="st">"softmax"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>model_output <span class="op">=</span> mobilenet(x)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> keras.Model(inputs<span class="op">=</span>image_input, outputs<span class="op">=</span>model_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="requirements-file" class="level3">
<h3 class="anchored" data-anchor-id="requirements-file">Requirements file</h3>
<p><code>Gunicorn</code> is used to deploy the API on several workers together to allow lower latency at the expense of increased compute consumption. Gunicorn is used since it implements WSGI. In a production environment, a front-facing server like <a href="https://www.nginx.com/"><strong>NGINX</strong></a> or <a href="https://httpd.apache.org/"><strong>Apache Web Server</strong></a> is used to host Static web pages and load balancers with Gunicorn running behind this layer to enable functionality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Flask<span class="op">==</span><span class="fl">2.0.3</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Pillow<span class="op">==</span><span class="fl">9.2.0</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>tensorflow<span class="op">==</span><span class="fl">2.9.1</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>gunicorn<span class="op">==</span><span class="fl">20.1.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="prepare-an-inference-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="prepare-an-inference-pipeline">2) Prepare an inference pipeline</h2>
<p>We define a simple function which accepts a <code>tf.Tensor</code> and runs it through the model to return a final top-5 predictions dictionary result.</p>
<section id="inference-function" class="level3">
<h3 class="anchored" data-anchor-id="inference-function">Inference function</h3>
<p>The image, accepted as a <code>tf.Tensor</code>, is inferred using the function prepared before. The <code>numpy</code> value of the tensor is then extracted to get all the confidence scores for each class.<br>
This numpy array is then passed into <code>keras.applications.imagenet_utils.decode_predictions</code> to get the top 5 predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference(image: tf.Tensor):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> model(image).numpy()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> keras.applications.imagenet_utils.decode_predictions(y, top<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {i[<span class="dv">1</span>] : <span class="bu">str</span>(i[<span class="dv">2</span>]) <span class="cf">for</span> i <span class="kw">in</span> preds[<span class="dv">0</span>]}</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">sorted</span>(result.items(), key<span class="op">=</span><span class="kw">lambda</span> item: item[<span class="dv">1</span>])}</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="make-a-simple-flask-app-to-expose-model-for-inference" class="level2">
<h2 class="anchored" data-anchor-id="make-a-simple-flask-app-to-expose-model-for-inference">3) Make a simple Flask App to expose model for inference</h2>
<p>Now, we define 2 simple endpoints at the routes <code>/</code> and <code>/inference</code>.<br>
- <code>/</code> (GET) : The first endpoint acts as a health-check to make sure that the API is up and running<br>
- <code>/inference</code> (POST) : The second endpoint accepts an image as a form field with the parameter name <code>image</code> and returns a dictionary with the confidence scores and the ImageNet class names</p>
<section id="flask-app-definition" class="level3">
<h3 class="anchored" data-anchor-id="flask-app-definition">Flask App definition</h3>
<p><code>app</code> is the name of the WSGI callable that will be used by Gunicorn later on. To know more about what WSGI is, check the Interesting Links section below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="definition-of-health-check-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="definition-of-health-check-endpoint">Definition of health-check endpoint</h3>
<p>To test whether the API is up and running, we simply hit a GET request on this endpoint to get the expected output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/"</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> health_check():</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'outcome'</span>:<span class="st">'endpoint working successfully'</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="definition-of-inference-endpoint" class="level3">
<h3 class="anchored" data-anchor-id="definition-of-inference-endpoint">Definition of inference endpoint</h3>
<p>Here, we accept a <code>POST</code> request, extract the <code>image</code> parameter from the files sent in the request. This is stored in a file-stream format which is then passed into a <code>PIL.Image.open</code> to prepare the image. Finally, we perform some simple pre-processing to convert the <code>PIL</code> image to a <code>tf.Tensor</code> and prepare a batch of 1 image to be passed into our inference function. The result returned is then passed into <code>jsonify</code> for response preparation and execution</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/inference"</span>, methods<span class="op">=</span>[<span class="st">'POST'</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> perform_inference():</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> request.files[<span class="st">'image'</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    pil_img <span class="op">=</span> Image.<span class="bu">open</span>(image.stream)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    tensor <span class="op">=</span> keras.preprocessing.image.img_to_array(pil_img)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    tensor <span class="op">=</span> tf.expand_dims(tensor, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> inference(tensor)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify(result)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="define-a-dockerfile-which-uses-gunicorn-for-deployment" class="level2">
<h2 class="anchored" data-anchor-id="define-a-dockerfile-which-uses-gunicorn-for-deployment">4) Define a Dockerfile which uses Gunicorn for deployment</h2>
<p>We are now done with defining our model and preparing it for inference using a simple Flask App. Here, we begin writing a <code>Dockerfile</code> and a <code>.dockerignore</code> to build a custom Docker Image</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>FROM ubuntu:<span class="fl">20.04</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>RUN apt<span class="op">-</span>get update <span class="op">&amp;&amp;</span> apt<span class="op">-</span>get install <span class="op">-</span>y <span class="op">\</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>git <span class="op">\</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>curl <span class="op">\</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>ca<span class="op">-</span>certificates <span class="op">\</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>python3 <span class="op">\</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>python3<span class="op">-</span>pip <span class="op">\</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>sudo <span class="op">\</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">&amp;&amp;</span> rm <span class="op">-</span>rf <span class="op">/</span>var<span class="op">/</span>lib<span class="op">/</span>apt<span class="op">/</span>lists<span class="op">/*</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>RUN useradd <span class="op">-</span>m docker_runner</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>RUN chown <span class="op">-</span>R docker_runner:docker_runner <span class="op">/</span>home<span class="op">/</span>docker_runner</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>COPY <span class="op">--</span>chown<span class="op">=</span>docker_runner <span class="op">*</span>.<span class="op">*</span> <span class="op">/</span>home<span class="op">/</span>docker_runner<span class="op">/</span>flask_app<span class="op">/</span>keras<span class="op">-</span>docker<span class="op">-</span>trial<span class="op">/</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>USER docker_runner</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="op">/</span>home<span class="op">/</span>docker_runner<span class="op">/</span>flask_app<span class="op">/</span>keras<span class="op">-</span>docker<span class="op">-</span>trial</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>ENV PATH<span class="op">=</span><span class="st">"$</span><span class="sc">{PATH}</span><span class="st">:/home/docker_runner/.local/bin"</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>RUN pip install <span class="op">--</span>no<span class="op">-</span>cache<span class="op">-</span><span class="bu">dir</span> <span class="op">-</span>r requirements.txt</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>ENTRYPOINT [<span class="st">"gunicorn"</span>, <span class="st">"--bind"</span>, <span class="st">"0.0.0.0:5000"</span>, <span class="st">"--workers=4"</span>, <span class="st">"app:app"</span>]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>EXPOSE <span class="dv">5000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="dockerfile">Dockerfile</h3>
<ul>
<li>The first line pulls the <code>ubuntu:20.04</code> image from Docker Hub to prepare a container with stock Ubuntu 20.04 Focal Fossa within it.<br>
</li>
<li>The first <code>RUN</code> command downloads and installs several essential packages that we require later ahead.</li>
<li>The next <code>RUN</code> command adds a user named docker_runner and creates a home directory for the user (using the -m option)</li>
<li>The next <code>RUN</code> command changes directory ownership and assigns docker_runner as the owner of its own home directory in a recursive manner for all files and subdirectories as well (using the -R option)</li>
<li>The <code>COPY</code> command moves all the files present in the current repository where the Dockerfile is into the container’s target directory</li>
<li>The <code>USER</code> command is used to change the current active user to <code>docker_runner</code></li>
<li>The <code>WORKDIR</code> command is used to change the current active directory to <code>/home/docker_runner/flask_app/keras-docker-trial</code></li>
<li>The <code>ENV</code> command is used to set the PATH environment variable and add our user’s <code>/.local/bin</code> directory to it</li>
<li>The <code>RUN</code> command is now used to install all the requirements and not use any cached directories or their SHA hashes while doing so</li>
<li>The <code>ENTRYPOINT</code> command is used to begin the API deployment using <code>gunicorn</code>. We bind the localhost’s port 5000 and start up 4 workers for this task. We specify the WSGI callable as <code>app</code> on the left side of <code>app:app</code>. If you changed the name of the Flask app in Step 3, then you should change this part as <code>{your_app_name}:app</code></li>
<li>The <code>EXPOSE</code> command is used to make the container listen on port 5000</li>
</ul>
</section>
<section id="dockerignore" class="level3">
<h3 class="anchored" data-anchor-id="dockerignore">.dockerignore</h3>
<p>We just ignore the <code>__pycache__/</code> directory as it generates intermediate files from CPython</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>__pycache__<span class="op">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="build-our-image" class="level2">
<h2 class="anchored" data-anchor-id="build-our-image">5) Build our image</h2>
<p>We now build our image and assign it a tag <code>keras-docker-trial</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>docker build . <span class="op">-</span>t keras<span class="op">-</span>docker<span class="op">-</span>trial <span class="op">--</span><span class="bu">file</span> Dockerfile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="define-a-simple-github-actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository" class="level2">
<h2 class="anchored" data-anchor-id="define-a-simple-github-actions-workflow-to-build-your-image-every-time-you-push-it-to-your-repository">6) Define a simple GitHub Actions workflow to build your image every time you push it to your repository</h2>
<p>Here, as an extra step, we use GitHub Actions to build our image as a test every time a Push is made to any branch or if a PR is merged in the repository. This needs to be added only if you are preparing a repository on GitHub for your model.</p>
<ul>
<li><code>name</code>&nbsp;: Assigns a name to the workflow</li>
<li><code>on</code>&nbsp;: Defines the triggers for when the workflow is to be used</li>
<li><code>env</code>&nbsp;: Sets environment variables</li>
<li><code>jobs</code>&nbsp;: Defines the different commands and workflow actions to be run as part of the current workflow</li>
<li><code>runs-on</code>&nbsp;: Defines which GitHub-hosted runner is used for execution of workflow</li>
<li><code>actions/checkout@v3</code>&nbsp;: Used to check-out the code from repository</li>
<li><code>Build Docker Image</code>&nbsp;: Build image from Dockerfile present in repository</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>name: Docker CI</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>on:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  push:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  pull_request:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    types: [<span class="st">'opened'</span>, <span class="st">'reopened'</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>env:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  BUILD_CONFIGURATION: Release</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>jobs:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  job1:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    runs<span class="op">-</span>on: ubuntu<span class="op">-</span>latest</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    steps:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: Check<span class="op">-</span>out the pushed code</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        uses: actions<span class="op">/</span>checkout<span class="op">@</span>v3</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">-</span> name: Build Docker image</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        run: docker build . <span class="op">-</span>t keras<span class="op">-</span>docker<span class="op">-</span>trial <span class="op">--</span><span class="bu">file</span> Dockerfile</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="test-the-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="test-the-pipeline">Test the pipeline</h2>
<p>Above, we have defined the model and deployed it using Docker and Gunicorn. You can find some example screenshots of the deployment and its predictions via Postman API Explorer below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/docker-blog/terminal.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image</figcaption><p></p>
</figure>
</div>
<p align="center">
Terminal command
</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/docker-blog/health-check.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image</figcaption><p></p>
</figure>
</div>
<p align="center">
GET request on health-check
</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/docker-blog/inference.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image</figcaption><p></p>
</figure>
</div>
<p align="center">
GET request on inference
</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/docker-blog/goldfish.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image</figcaption><p></p>
</figure>
</div>
<p align="center">
The Goldfish image sent for request via Postman
</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Above, we have completed the development of a simple Keras model, its deployment via Docker and a GitHub Actions workflow for CI(Continuous Integration).</p>
</section>
<section id="future-scope" class="level2">
<h2 class="anchored" data-anchor-id="future-scope">Future Scope</h2>
<p>This is only a small part of what can be done as a part of a simple MLOps pipeline. CML (Continuous Machine Learning) and DVC (Data Version Control) are two important concepts that are an integral part of every self-sustaining machine learning workflow and can be explored further. Resources to do so are present in the Interesting Links section.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>1.) <a href="https://docs.docker.com/docker-hub/">Docker Hub Documentation</a><br>
2.) <a href="https://keras.io/api/applications/mobilenet/#mobilenetv2-function">Keras Applications Documentation</a><br>
3.) <a href="https://docs.gunicorn.org/en/stable/configure.html">Gunicorn Documentation</a></p>
</section>
<section id="interesting-links" class="level2">
<h2 class="anchored" data-anchor-id="interesting-links">Interesting Links</h2>
<p>1.) <a href="https://cml.dev/">What is CML?</a><br>
2.) <a href="https://dvc.org/doc/user-guide/what-is-dvc">What is DVC?</a><br>
3.) <a href="https://wsgi.readthedocs.io/en/latest/what.html">What is WSGI (Web Server Gateway Interface)?</a><br>
4.) <a href="https://neptune.ai/blog/mlops">Detailed blog on What is MLOps?</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>